# ======================================================
# üê≥ DOCKERFILE - PSM CHIMERA BACKEND
# ======================================================

FROM node:20-alpine AS base

# Instalar depend√™ncias necess√°rias
RUN apk add --no-cache openssl curl postgresql-client

WORKDIR /app

# ======================================================
# üì¶ DEPENDENCIES STAGE
# ======================================================
FROM base AS deps

# Copiar arquivos de depend√™ncias
COPY package*.json ./

# Instalar depend√™ncias
RUN npm ci

# ======================================================
# üöÄ PRODUCTION STAGE
# ======================================================
FROM base AS production

WORKDIR /app

# Copiar depend√™ncias
COPY --from=deps /app/node_modules ./node_modules

# Copiar c√≥digo fonte
COPY database/prisma ./database/prisma
COPY src/ ./src/
COPY package*.json ./
COPY tsconfig.json ./

# Gerar Prisma Client (especificando o caminho do schema)
RUN npx prisma generate --schema=./database/prisma/schema.prisma

# Build do TypeScript
RUN npm run build

# Criar usu√°rio n√£o-root
RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nodejs
RUN chown -R nodejs:nodejs /app
USER nodejs

# Expor porta
EXPOSE 3000

# Comando padr√£o: executar setup do banco e sair
CMD ["npm", "run", "db:setup"]

# ======================================================
# üñ•Ô∏è SERVER STAGE
# ======================================================
FROM production AS server

# Mudar usu√°rio para root temporariamente para fazer ajustes
USER root

# Copiar scripts compilados
COPY --chown=nodejs:nodejs --from=production /app/dist ./dist

# Voltar para usu√°rio n√£o-root
USER nodejs

# Comando para iniciar o servidor
CMD ["npm", "start"]
