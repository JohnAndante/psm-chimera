# Plano de A√ß√£o - PSM Ch#### **‚úÖ MIGRA√á√ÉO PRISMA ‚Üí KYSELY CONCLU√çDA**

- **100% dos services migrados** para Kysely
- **Prisma restrito apenas** ao `database/seed.ts`
- **Performance melhorada** com queries type-safe
- **C√≥digo mais limpo** e maint√≠dvel

#### **‚úÖ SISTEMA DE QUERY UNIFICADO**

- **queryMiddleware implementado** - substitui middlewares separados
- **Filtros, pagina√ß√£o, ordena√ß√£o** centralizados
- **Case-insensitive search** com ILIKE
- **Column mapping** para flexibilidade de API

#### **‚úÖ DOCUMENTA√á√ÉO T√âCNICA COMPLETA**

- **Padr√µes arquiteturais** bem definidos
- **Instru√ß√µes detalhadas** para development
- **Sistema de query documentado** completamente
- **Git workflow** padronizadoatus Atual do Projeto (Outubro 2025)**

### **‚úÖ CONCLU√çDO - Arquitetura Base Moderna**

- **Backend TypeScript + Express** - Sistema base implementado
- **Sistema de Query Unificado** - queryMiddleware para filtros/pagina√ß√£o/ordena√ß√£o
- **Kysely ORM** - Migra√ß√£o completa de Prisma para Kysely (exceto seed)
- **Frontend React + TypeScript** - Interface moderna com Tailwind CSS
- **Documenta√ß√£o Completa** - Arquitetura, padr√µes e sistema de query documentados
- **Padr√µes de C√≥digo** - Instru√ß√µes detalhadas para controllers, services e rotas

### **‚ö†Ô∏è SITUA√á√ÉO ATUAL DO AGENDAMENTO**

**DESCOBERTA IMPORTANTE:** O sistema de agendamento cron est√° implementado mas **N√ÉO FUNCIONA AUTOMATICAMENTE**:

- ‚úÖ **Infraestrutura existe**: `node-cron`, tabelas `job_configurations`, `CronTestService`
- ‚ùå **Nenhum job inicia automaticamente** no startup do servidor
- ‚ùå **Sistema funciona 100% sob demanda** via API
- ‚ùå **Nenhuma integra√ß√£o com jobs do banco de dados**

### **üîç OUTRAS DESCOBERTAS T√âCNICAS IMPORTANTES**

#### **‚úÖ MIGRA√á√ÉO PRISMA ‚Üí KYSELY CONCLU√çDA**

- **100% dos services migrados** para Kysely
- **Prisma restrito apenas** ao `database/seed.ts`
- **Performance melhorada** com queries type-safe
- **C√≥digo mais limpo** e maint√≠vel

#### **‚úÖ SISTEMA DE QUERY UNIFICADO**

- **queryMiddleware implementado** - substitui middlewares separados
- **Filtros, pagina√ß√£o, ordena√ß√£o** centralizados
- **Case-insensitive search** com ILIKE
- **Column mapping** para flexibilidade de API

#### **‚úÖ DOCUMENTA√á√ÉO T√âCNICA COMPLETA**

- **Padr√µes arquiteturais** bem definidos
- **Instru√ß√µes detalhadas** para development
- **Sistema de query documentado** completamente
- **Git workflow** padronizado

### **üìã Objetivo Principal Atualizado**

Completar a migra√ß√£o do `server-node-fill` (hardcoded) para sistema configur√°vel via UI:

- ‚úÖ Configurar integra√ß√µes A (RP) e B (CresceVendas) dinamicamente
- üîÑ **PRIORIDADE**: Implementar jobs autom√°ticos funcionais (5h e 5h30)
- ‚úÖ Notifica√ß√µes via Telegram configur√°veis (base implementada)
- üîÑ Compara√ß√£o automatizada de dados

---

## üîß **BACKEND - Status e Implementa√ß√µes**

### **1. ÔøΩ Configura√ß√£o de Integra√ß√µes Externas**

#### **‚úÖ BASE IMPLEMENTADA**

- **Tipos b√°sicos**: `IntegrationType`, interfaces de database
- **Services base**: `integration.service.ts` com Kysely
- **Controllers**: CRUD completo para integra√ß√µes
- **Valida√ß√£o**: Joi validators implementados

#### **‚úÖ SERVICES DE INTEGRA√á√ÉO EXTERNOS**

```typescript
// ‚úÖ J√Å IMPLEMENTADOS
- rp.integration.service.ts - Completo com autentica√ß√£o e produtos
- crescevendas.integration.service.ts - Completo com campanhas
- telegram.service.ts - Notifica√ß√µes funcionais
- sync.job.service.ts - Sistema de sync migrado para Kysely
```

#### **üîÑ NECESS√ÅRIO IMPLEMENTAR**

```typescript
// src/services/job-scheduler.service.ts - CRIAR URGENTE
export class JobSchedulerService {
  static async initialize(): Promise<void>
  static async loadJobsFromDatabase(): Promise<void>
  static async scheduleJob(config: JobConfiguration): Promise<void>
  static async stopJob(jobId: string): Promise<void>
  private static jobs: Map<string, cron.ScheduledTask>
}
```

#### **üîÑ TIPOS EXPANDIDOS NECESS√ÅRIOS**

```typescript
// src/types/integration.type.ts - EXPANDIR
export interface RPIntegrationConfig {
  auth_method: 'TOKEN' | 'LOGIN';
  static_token?: string;
  token_header?: string;
  login_endpoint?: string;
  username?: string;
  password?: string;
  products_endpoint?: string;
  pagination?: {
    method: 'OFFSET' | 'CURSOR';
    param_name: string;
  };
}

export interface CresceVendasConfig {
  auth_headers: Record<string, string>;
  send_products_endpoint?: string;
  get_products_endpoint?: string;
  campaign_config?: {
    name_template: string;
    start_time: string;
    end_time: string;
  };
}
```

### **2. üîÑ Sistema de Jobs e Agendamento**

#### **‚úÖ IMPLEMENTADO**

- **Tabelas de banco**: `job_configurations`, `job_executions`, `job_notifications`
- **Tipos b√°sicos**: `JobType`, `ExecutionStatus` em `database.ts`
- **SyncJobService**: Migrado completamente para Kysely
- **CronTestService**: Funcional para testes manuais
- **Controllers**: `sync.controller.ts`, `cron.test.controller.ts`

#### **‚ùå PROBLEMA CR√çTICO IDENTIFICADO**

```typescript
// ‚ùå FALTANDO: Inicializa√ß√£o autom√°tica no startup
// backend/src/index.ts atual:
app.listen(SERVER_PORT, () => {
    console.log(`üöÄ PSM Chimera Backend rodando na porta ${SERVER_PORT}`);
    // ‚ùå Nenhum job √© inicializado aqui!
});

// ‚úÖ NECESS√ÅRIO:
app.listen(SERVER_PORT, async () => {
    console.log(`üöÄ PSM Chimera Backend rodando na porta ${SERVER_PORT}`);
    await JobSchedulerService.initialize(); // ‚Üê FALTANDO!
    console.log('üìÖ Jobs autom√°ticos inicializados');
});
```

#### **üîÑ IMPLEMENTA√á√ïES URGENTES**

```typescript
// src/services/job-scheduler.service.ts - CRIAR AGORA
export class JobSchedulerService {
  private static jobs = new Map<string, cron.ScheduledTask>();

  static async initialize(): Promise<void> {
    const activeJobs = await this.loadActiveJobsFromDB();
    for (const job of activeJobs) {
      await this.scheduleJob(job);
    }
  }

  private static async loadActiveJobsFromDB() {
    return db.selectFrom('job_configurations')
      .selectAll()
      .where('active', '=', true)
      .where('deleted_at', 'is', null)
      .execute();
  }

  static async scheduleJob(config: JobConfiguration): Promise<void> {
    const task = cron.schedule(config.cron_pattern, async () => {
      await this.executeJob(config);
    }, { timezone: "America/Sao_Paulo" });

    this.jobs.set(config.id.toString(), task);
  }
}
```

### **3. üì± Controllers e APIs**

#### **‚úÖ IMPLEMENTADO**

```typescript
// ‚úÖ Controllers existentes e funcionais:
- auth.controller.ts - Autentica√ß√£o JWT completa
- user.controller.ts - CRUD com queryMiddleware
- integration.controller.ts - CRUD completo
- store.controller.ts - Gerenciamento de lojas
- sync.controller.ts - Execu√ß√£o manual de syncs
- cron.test.controller.ts - Testes de cron
- notificationChannel.controller.ts - Canais Telegram
- log.controller.ts - Logs com SSE streaming
```

#### **üîÑ MELHORIAS NECESS√ÅRIAS**

```typescript
// src/controllers/integration.controller.ts - EXPANDIR
static testConnection(req: AuthenticatedRequest, res: Response) {
  // Testar conex√£o com integra√ß√£o (RP/CresceVendas)
}

static validateConfig(req: AuthenticatedRequest, res: Response) {
  // Validar configura√ß√£o antes de salvar
}

// src/controllers/job.controller.ts - CRIAR
export class JobController {
  static createJob(req: AuthenticatedRequest, res: Response)
  static scheduleJob(req: AuthenticatedRequest, res: Response)
  static stopJob(req: AuthenticatedRequest, res: Response)
  static getActiveJobs(req: AuthenticatedRequest, res: Response)
  static getExecutionHistory(req: AuthenticatedRequest, res: Response)
}
```

### **4. üîî Sistema de Notifica√ß√µes**

#### **‚úÖ FUNCIONAL COMPLETAMENTE**

```typescript
// ‚úÖ notification.template.service.ts - COMPLETO
export class NotificationTemplateService {
  static getSyncStartTemplate(storeCount: number, configName?: string): string
  static getSyncSuccessTemplate(results: SyncResult[], summary: SyncSummary): string
  static getSyncErrorTemplate(error: string, configName?: string): string
  static getCompareResultTemplate(comparison: CompareResult[]): string
  static getScheduledJobFailureTemplate(jobName: string, error: string): string
  static getScheduledJobSuccessTemplate(jobName: string, summary: SyncSummary): string
  // + mais templates implementados
}

// ‚úÖ telegram.service.ts - FUNCIONAL
// ‚úÖ notification-channel.service.ts - CRUD completo
// ‚úÖ Controllers e routes funcionais
```

### **5. üìä Logs e Auditoria**

#### **‚úÖ FUNCIONALIDADE COMPLETA**

```typescript
// ‚úÖ Tabelas de banco implementadas:
- log_entries: Logs estruturados com UUID, n√≠veis, metadata JSON
- job_executions: Hist√≥rico completo com metrics e error_details
- sync_executions: Logs espec√≠ficos de sync com stores_processed

// ‚úÖ Services funcionais:
- log.service.ts - CRUD completo com Kysely
- Logs autom√°ticos em todos os services
- SSE streaming para logs em tempo real no frontend

// ‚úÖ Features avan√ßadas:
- Filtros por n√≠vel, categoria, fonte
- Pagina√ß√£o e busca
- Metadata JSON estruturada
- Retention autom√°tica (7 dias configur√°vel)
```

---

## üé® **FRONTEND - Status e Implementa√ß√µes**

### **1. üìã Base T√©cnica Moderna**

#### **‚úÖ STACK IMPLEMENTADA**

```typescript
// ‚úÖ Base t√©cnica completa:
- React 18 + TypeScript
- Vite para build otimizado
- Tailwind CSS + shadcn/ui components
- Zustand para state management
- React Hook Form + validation
- Framer Motion para anima√ß√µes
- TanStack Table para data tables avan√ßadas
```

### **2. üìã P√°ginas Implementadas**

#### **‚úÖ P√ÅGINAS FUNCIONAIS**

- **LoginPage** - Autentica√ß√£o JWT completa
- **DashboardPage** - Overview do sistema
- **UsersPage** - CRUD completo com DataTable avan√ßada
- **IntegrationsPage** - Base implementada, precisa expans√£o
- **LogsPage** - Visualiza√ß√£o em tempo real com SSE
- **CronTestPage** - Interface para testes de cron
- **SyncPage** - Execu√ß√£o manual de syncs
- **NotificationChannelsPage** - Gerenciamento de canais Telegram

#### **üîÑ P√ÅGINAS A CRIAR/EXPANDIR**

```typescript
// src/pages/JobsPage/ - CRIAR URGENTE
- Configura√ß√£o visual de jobs autom√°ticos
- Sele√ß√£o de integra√ß√µes source/target
- Cron expression builder visual
- Sele√ß√£o de lojas com filtros
- Configura√ß√£o de notifica√ß√µes

// src/pages/IntegrationsPage/ - EXPANDIR
- Wizard por tipo de integra√ß√£o (RP/CresceVendas)
- Formul√°rios din√¢micos baseados no tipo
- Teste de conex√£o em tempo real
- Preview de configura√ß√£o JSON
```

### **3. ÔøΩ Componentes e Infraestrutura**

#### **‚úÖ COMPONENTES BASE IMPLEMENTADOS**

```typescript
// ‚úÖ UI Components (shadcn/ui completo):
- DataTable avan√ßada com sorting/filtering/pagination
- Forms com valida√ß√£o em tempo real
- Modal/Dialog systems
- Loading states e skeletons
- Toast notifications
- Sidebar navigation responsiva

// ‚úÖ Custom Components funcionais:
- AnimatedWrapper (framer-motion)
- RoutineStatusBadge
- TextareaWithCounter
- Layout components (PageContainer, PageCard)
- ProfileModal com logout
```

#### **ÔøΩ COMPONENTES ESPEC√çFICOS A CRIAR**

```typescript
// src/components/integration/ - EXPANDIR
- IntegrationTypeSelector (RP/CresceVendas/Telegram)
- RPConfigForm (auth methods, endpoints)
- CresceVendasConfigForm (headers, campaigns)
- IntegrationTester (conex√£o em tempo real)
- ConfigPreview (JSON viewer)

// src/components/jobs/ - CRIAR
- CronScheduleBuilder (visual cron expression)
- StoreSelector (multi-select com search)
- NotificationChannelSelector
- JobConfigWizard (step-by-step)
- JobStatusMonitor (tempo real)

// src/components/execution/ - EXPANDIR
- ExecutionButton (estados de loading)
- LiveLogViewer (j√° existe base no LogsPage)
- ExecutionHistoryTable
- ComparisonResultsViewer
- PerformanceMetrics charts
```

### **4. üìä Estado dos Controllers Frontend**

#### **‚úÖ APIs IMPLEMENTADAS**

```typescript
// ‚úÖ Controllers funcionais:
- auth-api.ts - Login/logout JWT
- users-api.ts - CRUD completo
- integration.controller.ts - Base implementada
- store.controller.ts - Gerenciamento lojas
- sync.controller.ts - Execu√ß√£o manual
- log.controller.ts - SSE streaming
- notification-channels-api.ts - Telegram

// üîÑ A expandir:
- jobs-api.ts - CRIAR (gerenciamento jobs)
- execution-api.ts - EXPANDIR (hist√≥rico, m√©tricas)
```

---

## üìÖ **Cronograma ATUALIZADO (Outubro 2025)**

### **üéØ FOCO IMEDIATO: Sistema de Jobs Autom√°ticos**

#### **ÔøΩ Sprint URGENTE (3-5 dias): Job Scheduler**

**Backend (CR√çTICO):**

- ‚úÖ Tipos e services j√° implementados
- üî• **CRIAR JobSchedulerService** - inicializa√ß√£o autom√°tica
- üî• **INTEGRAR com index.ts** - startup autom√°tico
- üî• **TESTAR jobs autom√°ticos** - 5h e 5h30
- üîÑ Expandir integration configs (RP/CresceVendas)

**Frontend (IMPORTANTE):**

- üîÑ P√°gina JobsPage - configura√ß√£o visual
- üîÑ Componentes de agendamento
- üîÑ Monitor de jobs ativos

### **üöÄ Sprint 2 (1 semana): Configura√ß√£o Din√¢mica**

**Backend:**

- ‚úÖ Integration services j√° funcionais
- üîÑ Expandir tipos de configura√ß√£o
- üîÑ Valida√ß√£o de configs
- üîÑ Teste de conex√µes

**Frontend:**

- üîÑ Wizard de configura√ß√£o de integra√ß√µes
- üîÑ Formul√°rios din√¢micos por tipo
- üîÑ Preview e teste de configura√ß√µes

### **üìä Sprint 3 (1 semana): Monitoramento e Finaliza√ß√£o**

**Sistema:**

- ‚úÖ Logs j√° implementados completamente
- üîÑ Dashboard de monitoramento
- üîÑ M√©tricas em tempo real
- üîÑ Alertas e notifica√ß√µes autom√°ticas
- üîÑ Migra√ß√£o final do server-node-fill

---

## üéØ **Estado Atual vs Server-Node-Fill**

### **‚úÖ VANTAGENS J√Å ALCAN√áADAS na V2:**

- **‚úÖ Arquitetura Moderna:** TypeScript + React + Kysely
- **‚úÖ Interface Gr√°fica:** UI completa para configura√ß√£o
- **‚úÖ Sistema de Query Unificado:** Filtros/pagina√ß√£o/ordena√ß√£o
- **‚úÖ Logs Estruturados:** Sistema completo de auditoria
- **‚úÖ Notifica√ß√µes Telegram:** Totalmente configur√°veis
- **‚úÖ Multi-usu√°rio:** Sistema de autentica√ß√£o e permiss√µes
- **‚úÖ Execu√ß√£o Manual:** Sync sob demanda funcional
- **‚úÖ Type Safety:** C√≥digo 100% tipado e validado

### **‚ö†Ô∏è GAPS IDENTIFICADOS vs Server-Node-Fill:**

| Funcionalidade | Server-Node-Fill | PSM Chimera V2 | Status |
|---|---|---|---|
| **Jobs Autom√°ticos** | ‚úÖ Funciona (5h/5h30) | ‚ùå N√£o inicia sozinho | üî• **CR√çTICO** |
| **Configura√ß√£o** | ‚ùå Hardcoded | ‚úÖ UI configur√°vel | ‚úÖ **MELHOR** |
| **Integra√ß√µes** | ‚úÖ RP + CresceVendas | ‚úÖ Services implementados | ‚úÖ **IGUAL** |
| **Notifica√ß√µes** | ‚úÖ Telegram b√°sico | ‚úÖ Sistema avan√ßado | ‚úÖ **MELHOR** |
| **Logs** | ‚ùå B√°sico | ‚úÖ Sistema completo | ‚úÖ **MELHOR** |
| **Interface** | ‚ùå Apenas c√≥digo | ‚úÖ UI completa | ‚úÖ **MELHOR** |

### **üîÑ PLANO DE MIGRA√á√ÉO ATUALIZADO:**

#### **Fase 1 (URGENTE - Esta Semana):**

1. ‚úÖ **Server-node-fill ainda rodando** - mant√©m opera√ß√£o
2. üî• **Implementar JobSchedulerService** - jobs autom√°ticos
3. üî• **Testar jobs 5h/5h30** - validar funcionamento
4. üîÑ **Configurar integra√ß√µes via UI** - dados atuais

#### **Fase 2 (Pr√≥xima Semana):**

1. üîÑ **Executar sync manual** - testar fluxo completo
2. üîÑ **Ativar 1 job autom√°tico** - teste em paralelo
3. üîÑ **Comparar resultados** - V2 vs server-node-fill
4. üîÑ **Ajustar diferen√ßas** - garantir paridade

#### **Fase 3 (Semana Seguinte):**

1. üîÑ **Migrar todos jobs autom√°ticos** - desligar server-node-fill
2. üîÑ **Monitorar 48h** - valida√ß√£o completa
3. üîÑ **Desativa√ß√£o definitiva** - server-node-fill
4. ‚úÖ **Migra√ß√£o conclu√≠da** - V2 operacional

---

## üèÜ **CONCLUS√ÉO: Estado Atual √© EXCELENTE**

### **‚úÖ O QUE J√Å TEMOS:**

- **Arquitetura s√≥lida e moderna** - Muito superior ao server-node-fill
- **95% da funcionalidade implementada** - Apenas jobs autom√°ticos faltando
- **Sistema mais robusto** - Logs, UI, multi-usu√°rio, type safety
- **Qualidade de c√≥digo alta** - Padr√µes estabelecidos e documentados

### **üéØ PR√ìXIMO PASSO CR√çTICO:**

Implementar JobSchedulerService para inicializa√ß√£o autom√°tica de jobs no startup

Estamos muito pr√≥ximos de ter um sistema 10x melhor que o atual! üöÄ
